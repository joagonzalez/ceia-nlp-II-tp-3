sequenceDiagram
participant U as Usuario
participant G as Grafo LangGraph
participant MEM as ShortMemory
participant PI as Pinecone Personas (opcional)
participant CI as Pinecone CVs
participant L as Groq LLM


U->>G: query (follow-up sobre la misma persona)
G->>L: COREF_SYS + pregunta (clasificador yes/no)
L-->>G: "yes" → reuse_last_persona=True
G->>G: decide_coref_with_llm → set reuse_last_persona
G->>G: resolve_people (usa last_persona, no consulta PI)
G->>G: decide_disambiguation → clear_top1 (persona_ids=[last_persona])
G->>CI: retrieve_cv_chunks(query, persona_ids)
CI-->>G: chunks (ordenados por score)
G->>MEM: reset_if_person_changed(session_id, persona_id)
MEM-->>G: (no resetea si persona_id no cambió)
G->>MEM: get(session_id, persona_id)
MEM-->>G: history (últ. N turnos)
G->>L: prompt(Contexto: chunks[0:4], Historia)
L-->>G: answer (con citas)
G->>MEM: append(session_id, persona_id, query, answer)
MEM-->>G: ok
G-->>U: answer